<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Rifa Jesús María Fuensanta</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@supabase/supabase-js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>

<body class="bg-gray-100 min-h-screen flex flex-col items-center justify-center p-4">
  <h1 class="text-3xl font-bold mb-4 text-center text-blue-700">RIFA JESÚS MARÍA FUENSANTA</h1>

  <!-- Selector de clases -->
  <select id="classSelect" class="mb-4 p-2 border rounded shadow">
    <option value="">Selecciona una clase</option>
    <option value="1A">1ºA</option>
    <option value="1B">1ºB</option>
    <option value="2A">2ºA</option>
    <option value="2B">2ºB</option>
    <option value="3A">3ºA</option>
    <option value="3B">3ºB</option>
  </select>

  <!-- Buscador -->
  <div class="mb-4 flex flex-col items-center">
    <input id="searchNumber" type="number" placeholder="Buscar número..." class="p-2 border rounded w-40 text-center" />
    <button id="searchBtn" class="mt-2 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Buscar</button>
    <p id="searchResult" class="mt-3 text-lg font-semibold text-gray-800"></p>
  </div>

  <!-- Botón sorteo -->
  <button id="raffleBtn" class="mb-4 px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">
    SORTEAR
  </button>

  <!-- Resultado -->
  <div id="winnerDisplay" class="text-2xl font-bold text-blue-800"></div>

  <!-- Popup agregar alumnos -->
  <div id="popup" class="fixed inset-0 bg-black bg-opacity-40 hidden items-center justify-center">
    <div class="bg-white p-6 rounded shadow-lg w-96">
      <h2 class="text-xl font-bold mb-4">Agregar alumnos</h2>

      <input type="file" id="fileInput" accept=".xlsx" class="mb-3" />
      <p class="text-gray-600 text-sm mb-2">O añade alumnos manualmente:</p>

      <textarea id="manualInput" class="w-full p-2 border rounded mb-3" rows="5"
        placeholder="Escribe los nombres, uno por línea"></textarea>

      <div class="flex justify-end gap-2">
        <button id="cancelPopup" class="px-3 py-1 bg-gray-400 text-white rounded">Cancelar</button>
        <button id="savePopup" class="px-3 py-1 bg-blue-600 text-white rounded">Guardar</button>
      </div>
    </div>
  </div>

  <script>
    const { createClient } = supabase;
    const supabaseUrl = "https://frwyfaeofgzlrlocerlc.supabase.co";
    const supabaseKey =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZyd3lmYWVvZmd6bHJsb2NlcmxjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYxMDkwNjQsImV4cCI6MjA3MTY4NTA2NH0.EDixTsOIqO5ovagH9ppAAqhLIFHvGVxaSrfStvlyxpY";
    const supabaseClient = createClient(supabaseUrl, supabaseKey);

    let alumnosData = {};
    let claseSeleccionada = "";

    const classSelect = document.getElementById("classSelect");
    const raffleBtn = document.getElementById("raffleBtn");
    const winnerDisplay = document.getElementById("winnerDisplay");
    const popup = document.getElementById("popup");
    const cancelPopup = document.getElementById("cancelPopup");
    const savePopup = document.getElementById("savePopup");
    const fileInput = document.getElementById("fileInput");
    const manualInput = document.getElementById("manualInput");
    const searchNumber = document.getElementById("searchNumber");
    const searchBtn = document.getElementById("searchBtn");
    const searchResult = document.getElementById("searchResult");

    // Cargar datos desde Supabase
    async function cargarDatos() {
      const { data, error } = await supabaseClient.from("rifa_datos").select("data").eq("id", 1).single();
      if (error) {
        console.error("Error cargando datos:", error);
        return {};
      }
      return data?.data || {};
    }

    // Guardar datos en Supabase
    async function guardarDatos() {
      const { error } = await supabaseClient
        .from("rifa_datos")
        .update({ data: alumnosData })
        .eq("id", 1);
      if (error) console.error("Error guardando datos:", error);
    }

    // Mostrar popup al seleccionar clase si está vacía
    classSelect.addEventListener("change", async () => {
      claseSeleccionada = classSelect.value;
      if (!claseSeleccionada) return;

      alumnosData = await cargarDatos();

      if (!alumnosData[claseSeleccionada] || alumnosData[claseSeleccionada].length === 0) {
        popup.classList.remove("hidden");
      }
    });

    // Cancelar popup
    cancelPopup.addEventListener("click", () => {
      popup.classList.add("hidden");
      classSelect.value = "";
    });

    // Guardar alumnos del popup
    savePopup.addEventListener("click", async () => {
      let alumnos = [];

      // Excel
      if (fileInput.files.length > 0) {
        const file = fileInput.files[0];
        const reader = new FileReader();
        reader.onload = async (e) => {
          const workbook = XLSX.read(e.target.result, { type: "binary" });
          const sheet = workbook.Sheets[workbook.SheetNames[0]];
          const data = XLSX.utils.sheet_to_json(sheet, { header: 1 }).flat().filter(x => x);
          alumnosData[claseSeleccionada] = data;
          await guardarDatos();
          popup.classList.add("hidden");
          alert("Alumnos cargados desde Excel correctamente.");
        };
        reader.readAsBinaryString(file);
        return;
      }

      // Manual
      const manual = manualInput.value.trim().split("\n").filter(x => x);
      if (manual.length > 0) {
        alumnosData[claseSeleccionada] = manual;
        await guardarDatos();
        popup.classList.add("hidden");
        alert("Alumnos añadidos manualmente correctamente.");
      } else {
        alert("Debes subir un Excel o escribir nombres.");
      }
    });

    // Botón de sorteo
    raffleBtn.addEventListener("click", async () => {
      if (!claseSeleccionada) {
        alert("Selecciona una clase primero.");
        return;
      }

      alumnosData = await cargarDatos();
      const lista = alumnosData[claseSeleccionada];
      if (!lista || lista.length === 0) {
        alert("No hay alumnos en esta clase.");
        return;
      }

      const ganador = lista[Math.floor(Math.random() * lista.length)];
      winnerDisplay.textContent = `🎉 Ganador: ${ganador} (${claseSeleccionada}) 🎉`;
    });

    // Buscador
    searchBtn.addEventListener("click", async () => {
      const numero = parseInt(searchNumber.value);
      if (isNaN(numero)) {
        alert("Introduce un número válido.");
        return;
      }

      alumnosData = await cargarDatos();
      let encontrado = null;
      let claseEncontrada = "";

      for (const clase in alumnosData) {
        if (numero > 0 && numero <= alumnosData[clase].length) {
          encontrado = alumnosData[clase][numero - 1];
          claseEncontrada = clase;
          break;
        }
      }

      if (encontrado) {
        searchResult.textContent = `🎟️ Nº ${numero}: ${encontrado} (${claseEncontrada})`;
      } else {
        searchResult.textContent = "❌ No encontrado";
      }
    });
  </script>
</body>
</html>
