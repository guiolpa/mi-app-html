<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Rifa Jes√∫s Mar√≠a Fuensanta</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center p-4">
  <h1 class="text-2xl font-bold mb-4">üéüÔ∏è Rifa Jes√∫s Mar√≠a Fuensanta</h1>

  <!-- Botones principales -->
  <div class="flex gap-2 mb-4">
    <button id="addClassBtn" class="bg-blue-500 text-white px-4 py-2 rounded">‚ûï Agregar clase</button>
    <button id="saveBtn" class="bg-green-500 text-white px-4 py-2 rounded">üíæ Guardar</button>
    <span id="saveStatus" class="text-gray-600 text-sm ml-2"></span>
  </div>

  <!-- Contenedor de clases -->
  <div id="classContainer" class="grid gap-4 w-full max-w-5xl"></div>

  <!-- Modal para agregar clase -->
  <div id="classModal" class="fixed inset-0 bg-black/40 hidden justify-center items-center">
    <div class="bg-white p-6 rounded-xl shadow-lg w-96">
      <h2 class="text-lg font-bold mb-4">Agregar clase</h2>
      <input id="className" type="text" placeholder="Nombre de la clase"
        class="border w-full p-2 rounded mb-3" />
      <div class="flex justify-end gap-2">
        <button id="cancelClassBtn" class="px-4 py-2 bg-gray-400 rounded text-white">Cancelar</button>
        <button id="confirmClassBtn" class="px-4 py-2 bg-blue-500 rounded text-white">Agregar</button>
      </div>
    </div>
  </div>

  <!-- Modal para configurar n√∫mero inicial -->
  <div id="startNumberModal" class="fixed inset-0 bg-black/50 hidden justify-center items-center">
    <div class="bg-white p-6 rounded-xl shadow-lg w-96">
      <h2 class="text-lg font-bold mb-3">Configurar boletos</h2>
      <p class="text-sm text-gray-700 mb-3">
        Introduce el n√∫mero por el que deben comenzar los boletos:
      </p>
      <input id="startNumberInput" type="number" placeholder="Ej: 1"
        class="border w-full p-2 rounded mb-3" />
      <button id="confirmStartNumber" class="bg-blue-600 text-white px-4 py-2 rounded w-full">
        Confirmar
      </button>
    </div>
  </div>

  <!-- Contenedor del buscador -->
  <div class="mt-4 w-full max-w-md">
    <input id="searchInput" type="text" placeholder="üîç Buscar por n√∫mero"
      class="w-full border rounded p-2 text-center" />
    <p id="searchResult" class="text-center text-gray-700 mt-2"></p>
  </div>

  <script type="module">
    // === CONFIGURACI√ìN SUPABASE ===
    import { createClient } from "https://esm.sh/@supabase/supabase-js";
    const supabaseUrl = "https://frwyfaeofgzlrlocerlc.supabase.co";
    const supabaseKey =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZyd3lmYWVvZmd6bHJsb2NlcmxjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYxMDkwNjQsImV4cCI6MjA3MTY4NTA2NH0.EDixTsOIqO5ovagH9ppAAqhLIFHvGVxaSrfStvlyxpY";
    const supabase = createClient(supabaseUrl, supabaseKey);

    // === VARIABLES ===
    const addClassBtn = document.getElementById("addClassBtn");
    const saveBtn = document.getElementById("saveBtn");
    const saveStatus = document.getElementById("saveStatus");
    const classContainer = document.getElementById("classContainer");
    const classModal = document.getElementById("classModal");
    const classNameInput = document.getElementById("className");
    const cancelClassBtn = document.getElementById("cancelClassBtn");
    const confirmClassBtn = document.getElementById("confirmClassBtn");
    const startNumberModal = document.getElementById("startNumberModal");
    const startNumberInput = document.getElementById("startNumberInput");
    const confirmStartNumber = document.getElementById("confirmStartNumber");
    const searchInput = document.getElementById("searchInput");
    const searchResult = document.getElementById("searchResult");

    let schoolData = {};

    // === MOSTRAR / OCULTAR MODAL CLASE ===
    addClassBtn.addEventListener("click", () => classModal.classList.remove("hidden"));
    cancelClassBtn.addEventListener("click", () => {
      classModal.classList.add("hidden");
      classNameInput.value = "";
    });

    confirmClassBtn.addEventListener("click", () => {
      const name = classNameInput.value.trim();
      if (!name) return alert("Introduce un nombre de clase");
      schoolData[name] = [];
      renderClasses();
      classModal.classList.add("hidden");
      classNameInput.value = "";
      saveData();
    });

    // === RENDERIZAR CLASES ===
    function renderClasses() {
      classContainer.innerHTML = "";
      Object.keys(schoolData).forEach((className) => {
        const div = document.createElement("div");
        div.className = "bg-white rounded-xl shadow p-4";
        div.innerHTML = `
          <h3 class="text-xl font-bold mb-2">${className}</h3>
          <button class="bg-blue-500 text-white px-3 py-1 rounded addStudent">‚ûï Alumno</button>
          <ul class="mt-2 space-y-1">
            ${schoolData[className]
              .map(
                (al) =>
                  `<li class="flex justify-between border-b pb-1">
                    <span>${al.nombre} (${al.numero})</span>
                    <span class="text-sm ${al.pagado ? "text-green-600" : "text-red-600"}">
                      ${al.pagado ? "‚úî Pagado" : "Pendiente"}
                    </span>
                  </li>`
              )
              .join("")}
          </ul>`;
        div.querySelector(".addStudent").addEventListener("click", () => {
          const nombre = prompt("Nombre del alumno:");
          if (!nombre) return;
          const numero = schoolData._nextNum || 1;
          schoolData._nextNum = numero + 1;
          schoolData[className].push({ nombre, numero, pagado: false });
          renderClasses();
          saveData();
        });
        classContainer.appendChild(div);
      });
    }

    // === BUSCADOR ===
    searchInput.addEventListener("input", () => {
      const query = parseInt(searchInput.value);
      if (!query) {
        searchResult.textContent = "";
        return;
      }

      for (const clase in schoolData) {
        const alumno = schoolData[clase].find((a) => a.numero === query);
        if (alumno) {
          searchResult.textContent = `${alumno.nombre} ‚Äî ${clase}`;
          return;
        }
      }
      searchResult.textContent = "No encontrado";
    });

    // === GUARDAR DATOS ===
    async function saveData(auto = false) {
      try {
        const { error } = await supabase
          .from("listas")
          .upsert([{ id: 1, contenido: JSON.stringify(schoolData) }], {
            onConflict: "id",
          });
        if (error) throw error;
        const now = new Date().toLocaleTimeString();
        saveStatus.textContent = auto
          ? `Guardado autom√°tico ‚úî (${now})`
          : `Guardado ‚úî (${now})`;
        saveStatus.style.color = auto ? "gray" : "green";
      } catch (err) {
        console.error("‚ùå Error al guardar:", err);
        saveStatus.textContent = "Error al guardar";
        saveStatus.style.color = "red";
      }
    }

    saveBtn.addEventListener("click", () => saveData(false));
    setInterval(() => {
      if (Object.keys(schoolData).length > 0) saveData(true);
    }, 60000);

    // === MODAL DE N√öMERO INICIAL ===
    confirmStartNumber.addEventListener("click", async () => {
      const start = parseInt(startNumberInput.value) || 1;
      schoolData._nextNum = start;
      startNumberModal.classList.add("hidden");
      await saveData();
    });

    // === CARGAR DATOS ===
    (async function loadData() {
      try {
        const { data, error } = await supabase
          .from("listas")
          .select("contenido")
          .eq("id", 1)
          .maybeSingle();

        if (error) throw error;

        if (data && data.contenido) {
          schoolData = JSON.parse(data.contenido);
          renderClasses();
        } else {
          startNumberModal.classList.remove("hidden");
        }
      } catch (err) {
        console.error("‚ùå Error al cargar datos:", err);
        startNumberModal.classList.remove("hidden");
      }
    })();
  </script>
</body>
</html>







